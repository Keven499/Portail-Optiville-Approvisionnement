@page "/affichage/{Id:int?}"
@using System.ComponentModel.DataAnnotations
@using Microsoft.EntityFrameworkCore
@using Microsoft.EntityFrameworkCore.Metadata.Internal
@using Microsoft.IdentityModel.Tokens
@using Newtonsoft.Json
@using Portail_OptiVille.Data.Models
@using System.Text.RegularExpressions
@inject NavigationManager Navigation
@using Portail_OptiVille.Data.FormModels
@using Portail_OptiVille.Data.Exceptions
@using Portail_OptiVille.Data.Services
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Portail_OptiVille.Data.Utilities
@using Portail_OptiVille.Pages.Approvisionnement.Contact
@using System.Linq.Expressions
@using System.Timers
@inject A2024420517riGr1Eq6Context _context
@inject NavigationManager navigationManager
@inject FichierService fichierService
@inject HistoriqueService historiqueService
@inject CoordonneeService coordonneeService
@inject IdentificationService identificationService
@inject FinanceService financeService
@inject ProduitServiceService produitServiceService
@inject LicenceRBQService licenceRBQService
@inject EncryptionService encryptionService
@inject ContactsService contactsService
@inject IJSRuntime JSRuntime
@inject PieceJointeFormModel pieceJointeFormModel
@inject ProtectedSessionStorage protectedSessionStorage
@inject NavigationManager NavigationManager
@inject ICookie cookie
@inject A2024420517riGr1Eq6Context _context
@inject JwtTokenGenerator tokenGenerator
<link rel="icon" type="image/x-icon" href="images/fiche.png">

<PageTitle>Fiche</PageTitle>
<div class="container-fluid">
    @if (isLoading)
    {
        <div class="d-flex justify-content-center align-items-center" style="height: 80vh; position: relative;">
            <div class="spinner-border text-success me-2" role="status"></div>
            <div class="d-flex flex-column">
                <span class="titre-medium fs-3">Chargement en cours..</span>
            </div>
        </div>
    }
    else
    {    
        <div class="row d-flex justify-content-center">
            <div class="col-xl-11">
                <div class="d-flex justify-content-end pb-3">
                    <button type="button" id="btnVert" class="btn bg-vert texte-bold text-white" style="height: 40px; width: 200px;" @onclick="ShowHistoriqueModalAsync"><i class="bi bi-clock-history"></i> Historique</button>
                </div> 
                        <div class="row">
                            <div class="modal fade" tabindex="-1" role="dialog" id="historiqueModal" data-bs-backdrop="static">
                                <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
                                    <div class="modal-content">
                                        <div class="modal-body p-0">
                                            <HistoriqueFiche idFournisseur="@Id" ShowTitle="false"/>
                                        </div>
                                        <div class="modal-footer border-0 d-flex justify-content-center bg-vertFonce">
                                            <button type="button" id="btnVert" class="btn bg-vert text-white texte-bold" data-bs-dismiss="modal"><i class="bi bi-x-circle me-1"></i>Fermer</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                <div class="card">
@*Demande*@
                    <div class="card-header py-2 bg-vertFonce d-flex justify-content-between align-items-center">
                        <h3 class="text-white titre-bold m-0">Demande</h3>
                        <button type="button" style="height: 40px; width: 200px;" class="btn bg-danger text-white texte-bold" data-bs-target="#ModalConfirmationDeleteFiche" data-bs-toggle="modal"><i class="bi bi-trash me-1"></i>Supprimer la fiche</button>
                    </div>
@*Bouton confirmation suppression*@
                    <div class="modal fade" id="ModalConfirmationDeleteFiche" tabindex="-1" aria-labelledby="ModalConfirmationDeleteFiche" aria-hidden="true" data-bs-backdrop="static">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header border-0 text-center w-100 bg-vert">
                                    <h1 class="modal-title fs-5 mx-auto texte-bold text-white" id="ModalConfirmationDeleteFiche">Êtes-vous sûre de vouloir effacer la fiche?</h1>
                                </div>
                                <div class="modal-footer border-0 d-flex justify-content-center bg-vertPale">
                                    <button type="button" id="btnVert" class="btn bg-vert texte-bold text-white" data-bs-dismiss="modal" @onclick="DeleteFiche"><i class="bi bi-check-circle me-1"></i>Confirmer</button>
                                    <button type="button" id="btnVert" class="btn bg-vert texte-bold text-white" data-bs-dismiss="modal"><i class="bi bi-x-circle me-1"></i>Annuler</button>
                                </div>
                            </div>
                        </div>
                    </div>
@*Apparait lorsqu'on change l'état de la fiche*@
                    <div class="card-body border-vertFonce">
                    @if(isConfirmed)
                    {
                        <div class="alert alert-success m-1" role="alert">
                            <h5 class="alert-heading">Le statut de la fiche a été changé!</h5>
                            <p class="mb-0">L'entreprise sera avisée par courriel.</p>
                        </div>
                    }
                        <div class="row d-flex align-items-start">
                            <div class="col-xl-6 col-lg-6 col-sm-12 col-12">                      
                                <div class="row mb-3">
                                    <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                        <label class="vertFonce texte-bold mb-0 mb-md-0 me-md-3" for="selectEtat">État</label>       
                                        <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                        <select value="@currentValue" @onchange="ConfirmChange" class="form-select input-vert texte-light py-1" style="width: 200px;" id="selectEtat">
                                            <option value="En attente">En attente</option>
                                            <option value="À réviser" hidden>À réviser</option>
                                            <option value="Modifiée" hidden>Modifiée</option>
                                            <option value="Désactivée" hidden>Désactivée</option>
                                            <option value="Accepté">Accepté</option>
                                            <option value="Refusé">Refusé</option>
                                        </select> 
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                        <div class="vertFonce texte-bold mb-0 mb-md-0 me-md-3">Dernière modification</div>
                                        <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                        <div class="vertFonce texte-medium">@((closestHistorique != null && closestHistorique.DateEtatChanged.HasValue) ? closestHistorique.DateEtatChanged.Value.ToString("yyyy-MM-dd") : "N/A")</div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                        <div class="vertFonce texte-bold mb-0 mb-md-0 me-md-3">Création</div>
                                        <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                        <div class="vertFonce texte-medium">@((selectedFournisseur.DateCreation.HasValue) ? selectedFournisseur.DateCreation.Value.ToString("yyyy-MM-dd") : "N/A")</div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                        <div class="vertFonce texte-bold mb-0 mb-md-0 me-md-3">Modification</div>
                                        <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                        <div class="vertFonce texte-medium">@((selectedFournisseur.DateLastChanged.HasValue) ? selectedFournisseur.DateLastChanged.Value.ToString("yyyy-MM-dd") : "N/A")</div>
                                    </div>
                                </div>
                            </div>
                            @if(isRefused)
                            {

                            <div class="col-xl-6 col-lg-6 col-sm-12 col-12">
                                <div class="row mb-3">
                                    <div class="col-xl-11 col-lg-11 col-sm-12 col-12 d-flex flex-column align-items-start">
                                        <label class="vertFonce texte-bold" for="reason">Raison du refus</label>
                                        <textarea @bind=strRaisonRefus id="reason" class="form-control w-100 input-vert texte-light" rows="4" style="resize: none; height: 100%;"></textarea>
                                        <button id="btnVert" class="btn bg-vert text-white texte-bold mt-1" style="width: 200px" @onclick="ConfirmRefus"><i class="bi bi-box-arrow-left me-1"></i>Soumettre</button>
                                    </div>  
                                </div>                
                            </div>
                            }
                            @if(closestHistorique.EtatDemande == "Refusé")
                            {
                            <div class="col-xl-6 col-lg-6 col-sm-12 col-12">
                                <div class="row mb-3">
                                    <div class="col-xl-11 col-lg-11 col-sm-12 col-12 d-flex flex-column align-items-start">
                                        <label class="vertFonce texte-bold" for="reason">Raison du refus</label>
                                        <textarea @bind="RaisonDuRefus" id="reason" class="form-control w-100 input-vert texte-light" rows="4" style="resize: none; height: 100%;"></textarea>
                                    </div>  
                                </div>                
                            </div>
                            }

                        </div> 
                        @if (FinanceInfoNull)
                        {
                            <div class="alert alert-warning alert-dismissible fade show text-center d-flex justify-content-center align-items-center" role="alert">
                                <strong>Veuillez entrer vos informations financières! <a href="/affichage/@selectedFournisseur.IdFournisseur#FinanceDest">(Cliquez ici)</a></strong>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        }                   
                    </div>
                @* Informations générales*@
                <EditForm Model="combinedFormModel" OnValidSubmit="SaveModifcationInfo">
                    <DataAnnotationsValidator />
                        <div class="card-header py-2 bg-vertFonce d-flex justify-content-between align-items-center rounded-0">
                            <h3 class="text-white titre-bold m-0">Informations générales</h3>
                                @if(modificationInfo)
                                {
                                    <button type="button" id="btnVert" class="btn bg-vert texte-bold text-white" style="height: 40px; width: 200px;" @onclick="ModifcationInfo"><i class="bi bi-pencil me-1"></i>Modifier</button>
                                }
                                else
                                {
                                    <button type="submit" id="btnVert" class="btn bg-vert texte-bold text-white" style="height: 40px; width: 200px;"><i class="bi bi-floppy me-1"></i>Sauvegarder</button> 
                                }                
                        </div>
                        <div class="card-body border-vertFonce">
                            <div class="row">
                                <div class="col-xl-6 col-12 col-lg-6 col-sm-12">                      
                                    <div class="row mb-3">
                                        <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                            <label for="inputEmail4" class="vertFonce texte-bold mb-0 mb-md-0 me-md-3">NEQ</label>
                                            <div class="flex-grow-1 d-none d-md-block ligneTxt"></div> <!-- Barre entre label et input -->
                                            <input type="text" style="width: 325px;" class="form-control input-vert texte-light py-1" id="inputEmail4" @bind="@combinedFormModel.IdentificationFormModel.NEQ" readonly="@modificationInfo">
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                            <label for="inputEmail4" class="vertFonce texte-bold mb-0 mb-md-0 me-md-3">Nom de l'entreprise</label>
                                            <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                            <div>
                                                <input type="text" style="width: 325px;" 
                                                    class="form-control @ValidateClass(errorMessagesInfoGen[0]) input-vert texte-light py-1" 
                                                    id="inputEmail4" 
                                                    @bind="@combinedFormModel.IdentificationFormModel.NomEntreprise" 
                                                    readonly="@modificationInfo">
                                                @((MarkupString)errorMessagesInfoGen[0])
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                            <label for="inputEmail4" class="vertFonce texte-bold mb-0 mb-md-0 me-md-3">Adresse courriel</label>
                                            <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                            <div>
                                                <input type="text" style="width: 325px;" 
                                                    class="form-control @ValidateClass(errorMessagesInfoGen[1]) input-vert texte-light py-1" id="inputEmail4" 
                                                    @bind="@combinedFormModel.IdentificationFormModel.CourrielEntreprise" 
                                                    readonly="@modificationInfo">
                                                @((MarkupString)errorMessagesInfoGen[1])
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                            <label for="province" class="vertFonce texte-bold mb-0 mb-md-0 me-md-3">Province</label>
                                            <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                            <select class="form-select input-vert texte-light py-1" id="province" @bind="@combinedFormModel.CoordonneeFormModel.ProvinceEntreprise" style="width: 325px; @(modificationInfo ? "pointer-events: none;" : null)">
                                            @foreach (var item in listeProvinces)
                                            {
                                                
                                                <option value="@item">@item</option>
                                            }
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                            <label for="regionAdministrative" class="vertFonce texte-bold mb-0 mb-md-0 me-md-3">Région administrative</label>
                                            <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                            <select class="form-select input-vert texte-light py-1" id="regionAdministrative" @bind="@combinedFormModel.CoordonneeFormModel.RegionAdmEntreprise" style="width: 325px; @(modificationInfo ? "pointer-events: none;" : null)">
                                            @foreach (var item in listeRegionADM)
                                            {
                                                
                                                <option value="@item">@item</option>
                                            }
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                            <label for="siteInternet" class="vertFonce texte-bold mb-0 mb-md-0 me-md-3">Site internet</label>
                                            <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                            <input type="text" style="width: 325px;" class="form-control input-vert texte-light py-1" id="siteInternet" @bind="@combinedFormModel.CoordonneeFormModel.SiteWebEntreprise" readonly="@modificationInfo">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xl-6 col-lg-6 col-sm-12 col-12">
                                    <div class="row mb-3">
                                        <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                            <label for="noEntreprise" class="vertFonce texte-bold mb-0 mb-md-0 me-md-3">No Civique</label>
                                            <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                            <div>
                                                <input type="text" style="width: 325px;" class="form-control @ValidateClass(errorMessagesInfoGen[2]) input-vert texte-light py-1" id="noEntreprise" @bind="@combinedFormModel.CoordonneeFormModel.NoEntreprise" readonly="@modificationInfo">
                                                @((MarkupString)errorMessagesInfoGen[2])
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                            <label for="rueEntreprise" class="vertFonce texte-bold mb-0 mb-md-0 me-md-3">Rue</label>
                                            <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                            <div>
                                                <input type="text" style="width: 325px;" class="form-control @ValidateClass(errorMessagesInfoGen[3]) input-vert texte-light py-1" id="rueEntreprise" @bind="@combinedFormModel.CoordonneeFormModel.RueEntreprise" readonly="@modificationInfo">
                                                @((MarkupString)errorMessagesInfoGen[3])
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                            <label for="bureauEntreprise" class="vertFonce texte-bold mb-0 mb-md-0 me-md-3">Bureau</label>
                                            <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                            <input type="text" style="width: 325px;" class="form-control input-vert texte-light py-1" id="bureauEntreprise" @bind="@combinedFormModel.CoordonneeFormModel.BureauEntreprise" readonly="@modificationInfo">
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                            <label for="villeEntreprise" class="vertFonce texte-bold mb-0 mb-md-0 me-md-3">Ville</label>
                                            <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                            <div>
                                                <input type="text" style="width: 325px;" class="form-control @ValidateClass(errorMessagesInfoGen[4]) input-vert texte-light py-1" id="villeEntreprise" @bind="@combinedFormModel.CoordonneeFormModel.VilleEntreprise" readonly="@modificationInfo">
                                                @((MarkupString)errorMessagesInfoGen[4])
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                            <label for="codePostal" class="vertFonce texte-bold mb-0 mb-md-0 me-md-3">Code Postal</label>
                                            <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                            <div>
                                                <input type="text" style="width: 325px;" class="form-control @ValidateClass(errorMessagesInfoGen[5]) input-vert texte-light py-1" id="codePostal" @bind="@combinedFormModel.CoordonneeFormModel.CodePostalEntreprise" readonly="@modificationInfo">
                                                @((MarkupString)errorMessagesInfoGen[5])
                                            </div>
                                        </div>
                                    </div>
                                </div>                    
                            </div>           
                            @if (phoneExistsResults != null)
                            {
                                var phoneNo = 1;
                                var phoneListCount = combinedFormModel.CoordonneeFormModel.PhoneList.Count;
                                foreach (var phoneModel in combinedFormModel.CoordonneeFormModel.PhoneList!)
                                {
                                    bool exists = phoneExistsResults[phoneNo - 1];
                                    <Telephone TelephoneNumber="@phoneNo" 
                                            telephoneFormModel="@phoneModel" 
                                            isView="@(exists)" 
                                            @ref="telephoneComponents[phoneModel]" />
                                    
                                    if (phoneNo < phoneListCount)
                                    {
                                        <hr class="m-0" />  
                                    }

                                    phoneNo++;
                                }
                            }
                            @if(!modificationInfo)
                            {
                                <div class="d-flex justify-content-center pb-2">
                                    <button type="button" class="btn bg-bleu text-white texte-bold me-2" id="btnBleu" @onclick="AddTelephone" style="width: 200px;" ><i class="bi bi-plus-circle"></i> Ajout</button>
                                    <button type="button" class="btn bg-danger text-white texte-bold" id="btnSupp" @onclick="RemoveTelephone" disabled="@(!(combinedFormModel.CoordonneeFormModel.PhoneList.Count > 1))" style="width: 200px;"><i class="bi bi-trash"></i> Retirer</button>
                                </div>
                            }
                    </div> 
                </EditForm>
@* Contacts*@
                <EditForm Model="contactHosterFormModel">
                    <DataAnnotationsValidator />
                        <div class="card-header py-2 bg-vertFonce d-flex justify-content-between align-items-center rounded-0">
                            <h3 class="text-white titre-bold m-0">Contacts</h3>
                            <button type="button" id="btnVert" class="btn bg-vert texte-bold text-white" style="height: 40px; width: 200px;" @onclick="ShowContactModalAsync"><i class="bi bi-pencil me-1"></i>Modifier</button>              
                        </div>
                        <div class="card-body border-vertFonce">
                            <div class="row">
                                @for (int i = 0; i < contactHosterFormModel.ContactList!.Count; i++)
                                {
                                    var contact = contactHosterFormModel.ContactList[i];
                                    <div class="col-xl-12 col-lg-12 col-sm-12 col-12">
                                        <h4 class="titre-bold vertFonce">Contact @(i + 1)</h4>
                                    </div>
                                    <div class="col-xl-6 col-lg-6 col-sm-12 col-12">
                                        <div class="row mb-3">
                                            <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                                <label for="prenomInput" class="vertFonce texte-bold">Prénom</label>
                                                <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                                <InputText id="prenomInput" style="width: 325px; outline: none;" class="form-control input-vert texte-light py-1" @bind-Value="contact.Prenom" readonly="@modificationContact" />
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                                <label for="nomInput" class="vertFonce texte-bold">Nom</label>
                                                <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                                <InputText id="prenomInput" style="width: 325px; outline: none;" class="form-control input-vert texte-light py-1" @bind-Value="contact.Nom" readonly="@modificationContact" />
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                                <label for="fonctionInput" class="vertFonce texte-bold">Fonction</label>
                                                <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                                <InputText id="prenomInput" style="width: 325px; outline: none;" class="form-control input-vert texte-light py-1" @bind-Value="contact.Fonction" readonly="@modificationContact" />
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                                <label for="courrielInput" class="vertFonce texte-bold">Adresse courriel</label>
                                                <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                                <InputText id="courrielInput" style="width: 325px; outline: none;" class="form-control input-vert texte-light py-1" @bind-Value="contact.AdresseCourriel" readonly="@modificationContact" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-6 col-lg-6 col-sm-12 col-12">
                                        <div class="row mb-3">
                                            <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                                <label for="telephoneType" class="me-2 vertFonce texte-bold">Numéro de téléphone</label>
                                                <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                                <select id="telephoneType" style="width: 325px; @(modificationContact ? "pointer-events: none;" : null)" class="form-select input-vert texte-light py-1" @bind="contact.TypeTelephone" readonly="@modificationContact">
                                                        <option value="Bureau">Bureau</option>
                                                        <option value="Télécopieur">Télécopieur</option>
                                                        <option value="Cellulaire">Cellulaire</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-xl-12 d-xl-flex justify-content-xl-end col-lg-12 d-lg-flex justify-content-lg-end col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">                                                
                                                <InputText id="prenomInput" style="width: 325px; outline: none;" class="form-control input-vert texte-light py-1" @bind-Value="contact.Telephone" readonly="@modificationContact" />
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                                <label for="posteInput" class="vertFonce texte-bold">Poste</label>
                                                <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                                <InputText id="prenomInput" style="width: 325px; outline: none;" class="form-control input-vert texte-light py-1" @bind-Value="contact.Poste" readonly="@modificationContact" />
                                            </div>
                                        </div>
                                    </div>  
@* ligne de séparation*@
                                    @if (i < contactHosterFormModel.ContactList.Count - 1) 
                                    {
                                        <div class="col-12">
                                            <hr class="py-1 bg-vertFonce" style="height: 3px;"/> 
                                        </div>
                                    }                                                               
                                }
                            </div>
                        </div>
@* Modification*@
                        <div class="row">
                            <div class="modal fade" tabindex="-1" role="dialog" id="ContactModal" data-bs-backdrop="static">
                                <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
                                    <div class="modal-content">
                                        <div class="modal-body p-0">
                                            <ContactFormHoster AssignReference="AssignReferenceContactFormHoster" ContactHosterFormModel="contactHosterFormModel" ShowTitle="false"></ContactFormHoster>
                                        </div>
                                        <div class="modal-footer border-0 d-flex justify-content-center bg-vertFonce">
                                            <button type="button" id="btnVert" class="btn bg-vert text-white texte-bold" data-bs-dismiss="modal"><i class="bi bi-x-circle me-1"></i>Annuler</button>
                                            <button type="submit" id="btnVert" class="btn bg-vert text-white texte-bold" @onclick="SaveContact"><i class="bi bi-floppy me-1"></i>Sauvegarder</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                </EditForm>
@* Produits et services*@
                <div class="card-header py-2 bg-vertFonce d-flex justify-content-between align-items-center rounded-0">
                    <h3 class="text-white titre-bold m-0">Produits et services</h3>
                    <button type="button" id="btnVert" class="btn bg-vert texte-bold text-white" style="height: 40px; width: 200px;" onclick="showModal('exampleModal')"><i class="bi bi-pencil me-1"></i>Modifier</button>              
                </div>  
                <div class="card-body border-vertFonce">
                    <div class="row">
                        <div class="col-xl-6 col-lg-6 col-sm-12 col-12">
                            @if (groupedServices != null && groupedServices.Count > 0)
                                {
                                    string currentCategory = null;
                                    string currentNature = null;

                                    foreach (var group in groupedServices)
                                    {
                                        if (currentCategory != group.Key.CodeCategorie || currentNature != group.Key.Nature)
                                        {                                               
                                            if (currentCategory != null)
                                            {
                                            <hr />
                                            }
                                            <div>
                                                <div class="vertFonce texte-bold">@group.Key.CodeCategorie - @group.Key.Nature</div>
                                            </div>
                                            currentCategory = group.Key.CodeCategorie;
                                            currentNature = group.Key.Nature;
                                        }
                                        foreach (var produitservice in group)
                                        {
                                            <div class="ms-4 mb-1">@produitservice.CodeUnspsc - @produitservice.Description</div>
                                        }
                                    }
                                }
                        </div>
                        <div class="col-xl-6 col-lg-6 col-sm-12 col-12">
                            <div class="row mb-3">
                                <div class="col-xl-11 col-lg-11 col-sm-12 col-12 d-flex flex-column align-items-start">
                                    <label for="TextAreaProduitService" class="vertFonce texte-bold">Détails et spécifications</label>
                                    <textarea id="TextAreaProduitService" class="form-control w-100 input-vert texte-light" rows="4" style="resize: none; height: 100%;" readonly="true">@selectedFournisseur.DetailSpecification</textarea>
                                </div>  
                            </div>
                        </div>
@* Modification*@
                        <div class="row">
                            <div class="modal fade" tabindex="-1" role="dialog" id="exampleModal" data-bs-backdrop="static">
                                <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
                                    <div class="modal-content">
                                        <div class="modal-body p-0">
                                            <ProduitsServices AssignReference="AssignReferenceProduitsServices" AllProduitServices="allProduitService" ProduitServiceFormModel="produitServiceFormModel" CategorieUNSPSC="categorieUNSPSC" ShowTitle="false"></ProduitsServices>
                                        </div>
                                        <div class="modal-footer border-0 d-flex justify-content-center bg-vertFonce">
                                            <button type="button" id="btnVert" class="btn bg-vert text-white texte-bold" data-bs-dismiss="modal"><i class="bi bi-x-circle me-1"></i>Annuler</button>
                                            <button type="submit" id="btnVert" class="btn bg-vert text-white texte-bold" @onclick="SaveModifcationProduitServices"><i class="bi bi-floppy me-1"></i>Sauvegarder</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>                                
                    </div>
                </div>
@* Licence RBQ*@
                <div class="card-header py-2 bg-vertFonce d-flex justify-content-between align-items-center rounded-0">
                    <h3 class="text-white titre-bold m-0">Licence RBQ</h3>
                    <button type="button" id="btnVert" class="btn bg-vert texte-bold text-white" style="height: 40px; width: 200px;" onclick="showModal('ModifierModalLicence')"><i class="bi bi-pencil me-1"></i>Modifier</button>             
                </div> 
                <div class="card-body border-vertFonce">
                    <div class="row">
                        <div class="col-xl-6 col-lg-6 col-sm-12 col-12">
                            <div class="row mb-3">
                                <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                        <label for="posteInput" class="vertFonce texte-bold">Statut</label>
                                        <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                        <div class="vertFonce texte-medium">@licencerbqs.Statut</div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                    <label for="IdLicenceRbq" class="me-3 vertFonce texte-bold">Numéro</label>
                                    <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                    <input type="text" style="width: 325px;" class="form-control input-vert texte-light py-1" readonly id="IdLicenceRbq" value="@licencerbqs.IdLicenceRbq">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                    <label for="TypeLicencerbq" class="me-3 vertFonce texte-bold">Type de licence</label>
                                    <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                    <input readonly type="text" style="width: 325px;" class="form-control input-vert texte-light py-1" id="TypeLicencerbq" value="@licencerbqs.Type">
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-6 col-lg-6 col-sm-12 col-12">
                            @if (selectedCategorieRBQ != null)
                            {
                                if (groupedCategories == null)
                                {
                                    groupedCategories = GroupCategoriesByType();
                                }
                                <div class="row">
                                    <div class="col-xl-6 col-lg-6 col-sm-12 col-12">
                                        <div class="vertFonce texte-bold">Général</div>
                                            @if (groupedCategories.ContainsKey("Général") && groupedCategories["Général"].Count > 0)
                                            {
                                                <div class="row">
                                                    <div class="col-xl-12 col-lg-12 col-12 col-sm-12">
                                                        @foreach (var categorie in groupedCategories["Général"])
                                                        {
                                                            <div class="ms-4 mb-1 texte-light">@categorie.CodeSousCategorie - @categorie.TravauxPermis</div>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="d-flex justify-content-center align-items-center">
                                                    <p>Aucune Catégorie</p>
                                                </div>
                                            }
                                    </div>
                                    <div class="col-xl-6 col-lg-6 col-sm-12 col-12">
                                        <div class="vertFonce texte-bold">Spécialisé</div>
                                            @if (groupedCategories.ContainsKey("Spécialisé") && groupedCategories["Spécialisé"].Count > 0)
                                            {
                                                <div class="row">
                                                    <div class="col-xl-12 col-lg-12 col-12 col-sm-12">
                                                        @foreach (var categorie in groupedCategories["Spécialisé"])
                                                        {
                                                            <div class="ms-4 mb-1 texte-light">@categorie.CodeSousCategorie - @categorie.TravauxPermis</div>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="d-flex justify-content-center align-items-center">
                                                    <p>Aucune Catégorie</p>
                                                </div>
                                            }
                                    </div>
                                </div>
                                }
                                else
                                {
                                    <p>Chargement...</p>
                                }
                                </div>
@* Modification*@
                        <div class="row">
                            <div class="modal fade" id="ModifierModalLicence" tabindex="-1" role="dialog" data-bs-backdrop="static">
                                <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
                                    <div class="modal-content">
                                        <div class="modal-body p-0">
                                            <LicenceRBQ AssignReference="AssignReferenceLicenceRBQ" LicenceRBQFormModel="licenceRBQFormModel" AllCategories="allCategories" ShowTitle="false"></LicenceRBQ>
                                        </div>
                                        <div class="modal-footer border-0 d-flex justify-content-center bg-vertFonce">
                                            <button type="button" id="btnVert" class="btn bg-vert text-white texte-bold" data-bs-dismiss="modal"><i class="bi bi-x-circle me-1"></i>Annuler</button>
                                            <button type="submit" id="btnVert" class="btn bg-vert text-white texte-bold" @onclick="SaveModifcationLicenceRBQ"><i class="bi bi-floppy me-1"></i>Sauvegarder</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
@* Pièces jointes*@
                <div class="card-header py-2 bg-vertFonce d-flex justify-content-between align-items-center rounded-0">
                    <h3 class="text-white titre-bold m-0">Brochures et cartes d'affaires</h3>            
                    @if(modificationPieceJointes)
                    {
                        <div class="col-xxl-6 col-xl-5 col-lg-3 p-0 d-flex justify-content-end align-items-center">
                            <button type="button" id="btnVert" class="btn bg-vert texte-bold text-white" style="height: 40px; width: 200px;" @onclick="ModifcationPieceJointes"><i class="bi bi-pencil me-1"></i>Modifier</button>
                        </div>
                    }
                    else
                    {
                        <div class="col-xxl-6 col-xl-5 col-lg-3 p-0 d-flex justify-content-end align-items-center">
                            <button type="button" id="btnVert" class="btn bg-vert texte-bold text-white" style="height: 40px; width: 200px;" @onclick="SaveModifcationPieceJointes"><i class="bi bi-floppy me-1"></i>Sauvegarder</button>
                        </div>
                    }
                </div> 
                <div class="card-body border-vertFonce">
                    <div class="row">
                        <div class="col-xl-12 col-lg-12 col-sm-12 col-12">    
                            <h3 class="texte-20bold">Total: @GetFormatSize()</h3>                                            
                            <PiecesJointes PieceJointeFormModel="pieceJointeFormModel" ActivationModification="ModifcationPieceJointesActivation" ModifcationPieceJointesActivationONState="ModifcationPieceJointesActivationONState" MaxSize="configappro.TailleMaxFichiers" ShowTitle="false"></PiecesJointes>                
                        </div>
                    </div>
                </div>
@* Finances*@
                @if(financeFormModel != null){
                    <EditForm EditContext="@editContext">
                        <DataAnnotationsValidator />
                            <div class="card-header py-2 bg-vertFonce d-flex justify-content-between align-items-center rounded-0">
                                <h3 class="text-white titre-bold m-0" id="FinanceDest">Finances</h3>                                
                                @if (modificationFinances)
                                {
                                    <button type="button" id="btnVert" class="btn bg-vert texte-bold text-white" style="height: 40px; width: 200px;" @onclick="ModifcationFinances"><i class="bi bi-pencil me-1"></i>Modifier</button>
                                }
                                else
                                {
                                    <button type="button" style="height: 40px; width: 200px;" @onclick="SaveModifcationFinances" id="btnVert" class="btn bg-vert texte-bold text-white"><i class="bi bi-floppy me-1"></i>Sauvegarder</button>
                                }          
                            </div>
                            <div class="card-body border-vertFonce">
                                <div class="row">
                                    <div class="col-xl-6 col-lg-6 col-sm-12 col-12"> 
                                        <div class="row mb-3">                                            
                                            <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                                <label for="inputTPS" class="vertFonce texte-bold">TPS</label>
                                                <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                                <div>
                                                    <input type="text" style="width: 325px;" class="form-control @GetInputClass(() => financeFormModel.NumeroTps) input-vert texte-light py-1" id="inputTPS" @bind="@financeFormModel.NumeroTps" readonly="@modificationFinances">                                                                                               
                                                    @((MarkupString)GetValidationHTML(() => financeFormModel.NumeroTps))
                                                </div>
                                            </div>                                                                                                                              
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                                <label for="inputTVQ" class="vertFonce texte-bold">TVQ</label>
                                                <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                                <div>
                                                    <input type="text" style="width: 325px;" class="form-control @GetInputClass(() => financeFormModel.NumeroTvq) input-vert texte-light py-1" id="inputTVQ" @bind="@financeFormModel.NumeroTvq" readonly="@modificationFinances">                                                                                               
                                                    @((MarkupString)GetValidationHTML(() => financeFormModel.NumeroTvq))
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-6 col-lg-6 col-sm-12 col-12"> 
                                        <div class="row mb-3">
                                            <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                                <label for="inputModeComm" class="vertFonce texte-bold">Mode de communication</label>
                                                <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                                <div>
                                                    <select class="form-select @GetInputClass(() => financeFormModel.ModeCommunication) input-vert texte-light py-1" id="inputModeComm" @bind="@financeFormModel.ModeCommunication"
                                                        style="@(modificationFinances ? "pointer-events: none;" : null) width: 325px; ">
                                                        <option value="" disabled selected>Choisir une option</option>
                                                        <option value="Courriel">Courriel</option>
                                                        <option value="Courrier régulier">Courrier régulier</option>
                                                    </select>      
                                                    @((MarkupString)GetValidationHTML(() => financeFormModel.ModeCommunication))  
                                                </div>                                    
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                                <label for="inputDevise" class="vertFonce texte-bold">Devise</label>
                                                <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                                <div>
                                                    <select class="form-select @GetInputClass(() => financeFormModel.Devise) input-vert texte-light py-1" id="inputDevise" @bind="@financeFormModel.Devise"
                                                        style="@(modificationFinances ? "pointer-events: none;" : null) width: 325px;">
                                                        <option value="" disabled selected>Choisir une option</option>
                                                        <option value="CAD">CAD</option>
                                                        <option value="USD">USD</option>
                                                    </select> 
                                                    @((MarkupString)GetValidationHTML(() => financeFormModel.Devise)) 
                                                </div>                                       
                                            </div>
                                            <div class="col-xl-11 d-xl-flex justify-content-xl-end col-lg-11 d-lg-flex justify-content-lg-end col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12 mt-1">
                                                
                                            </div> 
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-xl-12 col-lg-12 col-12 d-md-flex flex-md-row flex-column align-items-md-center col-sm-12">
                                                <label for="inputCondPaiement" class="vertFonce texte-bold">Conditions de paiement</label>
                                                <div class="flex-grow-1 d-none d-md-block ligneTxt"></div>
                                                <div>
                                                    <select class="form-select @GetInputClass(() => financeFormModel.ConditionPaiement) input-vert texte-light py-1" id="inputCondPaiement" @bind="@financeFormModel.ConditionPaiement" readonly="@modificationFinances"
                                                        style="@(modificationFinances ? "pointer-events: none;" : null)width: 325px;">
                                                        <option value="" disabled selected>Choisir une option</option>
                                                        @foreach (var item in listConditionPaiement)
                                                        {
                                                            <option value="@item">@item</option>
                                                        }
                                                    </select>     
                                                    @((MarkupString)GetValidationHTML(() => financeFormModel.ConditionPaiement))    
                                                </div>                                  
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    </EditForm>
                }   
            </div>
        </div>
    </div>
    }
</div>
<script src="@popperScript"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
<script>
    function showModal(modalId) {
        const existingBackdrop = document.querySelector('.modal-backdrop');
        if (existingBackdrop) {
            existingBackdrop.remove();
        }

        var modalElement = document.getElementById(modalId);
        if (modalElement) {
            var modal = new bootstrap.Modal(modalElement, {
                backdrop: 'static',
                keyboard: false
            });

            modal.show();
        }
    }

    function hideModal(modalId) {
        var modalElement = document.getElementById(modalId);
        if (modalElement) {
            var modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (modalInstance) {
                modalInstance.hide();
            }
        }
    }
</script>

<style>
    select option:first-child:checked {
        display: none;
    }
</style>

@code{
    private bool isValidFormFinance = false;
    private List<bool> phoneExistsResults;
    private string email = string.Empty;
    private string[] errorMessagesInfoGen = Enumerable.Repeat(string.Empty, 6).ToArray();
    private bool isRefused = false;
    private string strRaisonRefus = "";
    private bool isConfirmed = false;
    private bool isLoading = true;
    [Parameter]
    public int Id { get; set; }
    private bool modificationFinances = true;
    private string popperScript = "https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js";
    private bool modificationInfo = true;
    private bool modificationPieceJointes = true;
    private bool FinanceInfoNull = false;
    private bool LicenceRBQInfoNull = false;
    private bool modificationContact = true;
    public int sizeTotal { get; set; } = 0;
    private CombinedFormModel combinedFormModel = new CombinedFormModel();
    private FinanceFormModel financeFormModel = new FinanceFormModel();
    private ContactHosterFormModel contactHosterFormModel = new ContactHosterFormModel();
    Produitservice produitService = new Produitservice();
    public int MaxSize = 0;
    Configappro configappro = new Configappro();
    private bool ModifcationPieceJointesActivation = true;
    private bool ModifcationPieceJointesActivationONState;
    private void ModifcationPieceJointesActivationONStateMethod()
    {
        ModifcationPieceJointesActivationONState = !modificationPieceJointes;
    }
    private Fichier? selectedFile;
    List<Portail_OptiVille.Data.Models.Contact> selectedContacts = new List<Portail_OptiVille.Data.Models.Contact>();
    List<Fichier> selectedFichiers = new List<Fichier>();
    List<Historique> selectedHistoriques = new List<Historique>();
    private Historique? closestHistorique;
    List<Licencerbq> selectedLicencerbqs = new List<Licencerbq>();
    List<Coordonnee> selectedCoordonnes = new List<Coordonnee>();
    List<Portail_OptiVille.Data.Models.Telephone> selectedTelephones = new List<Portail_OptiVille.Data.Models.Telephone>();
    List<Telephone> selectedTelephonesContacts = new List<Telephone>();
    Fournisseur selectedFournisseur = new Fournisseur();
    Identification identification = new Identification();
    private Dictionary<TelephoneFormModel, Telephone> telephoneComponents = new Dictionary<TelephoneFormModel, Telephone>();
    List<Categorierbq> selectedCategorieRBQ = new List<Categorierbq>();
    Finance finance = new Finance();
    Dictionary<string, List<Categorierbq>>? groupedCategories;
    Coordonnee coordonnee = new Coordonnee();
    Licencerbq licencerbqs = new Licencerbq();
    List<ContactPhoneInfo> contactPhoneInfo = new List<ContactPhoneInfo>();
    private List<Categorierbq> allCategories = new List<Categorierbq>();
    private List<Categorierbq> allCategoriesForm = new List<Categorierbq>();
    private LicenceRBQFormModel licenceRBQFormModel = new LicenceRBQFormModel();
    private List<string> listConditionPaiement = new List<string>{
        "Payable immédiatement sans déduction",
        "Payable immédiatement sans déduction, Date de base au 15 du mois suivant",
        "Dans les 15 jours 2% escompte, dans les 30 jours sans déduction",
        "Après entrée facture jusqu'au 15 du mois, jusqu'au 15 du mois suivant 2% escompte",
        "Dans les 10 jours 2% escompte, dans les 30 jours sans déduction",
        "Dans les 15 jours sans déduction",
        "Dans les 30 jours sans déduction",
        "Dans les 45 jours sans déduction",
        "Dans les 60 jours sans déduction"
        };
    private List<string> listeRegionADM = new List<string>{"(01) Bas-Saint-Laurent", "(02) Saguenay-Lac-Saint-Jean", "(03) Capitale-Nationale",
        "(04) Mauricie", "(05) Estrie", "(06) Montréal", "(07) Outaouais", "(08) Abitibi-Témiscamingue", "(09) Côte-Nord", "(10) Nord-du-Québec",
        "(11) Gaspésie-Îles-de-la-Madeleine", "(12) Chaudière-Appalaches", "(13) Laval", "(14) Lanaudière", "(15) Laurentides", "(16) Montérégie",
        "(17) Centre-du-Québec"};
    private List<string> listeProvinces = new List<string>{"Québec", "Ontario", "Manitoba", "Saskatchewan", "Alberta", "Colombie-Britannique",
        "Île-du-Prince-Édouard", "Nouveau-Brunswick", "Nouvelle-Écosse", "Terre-Neuve-et-Labrador", "Nunavut", "Territoires du Nord-Ouest",
        "Yukon"};
    private LicenceRBQ licenceRBQRef;   
    private ContactFormHoster ContactFormHosterRef; 
    public Action<ContactFormHoster>? AssignReferenceContactFormHoster => (contactFormHoster) => ContactFormHosterRef = contactFormHoster;
    private Action<LicenceRBQ> AssignReferenceLicenceRBQ => (licenceRBQ) => licenceRBQRef = licenceRBQ;
    List<IGrouping<GroupKey, Produitservice>>? groupedServices;
    private Dictionary<string, bool> selectedCurrentCategorieRBQ = new Dictionary<string, bool>();
    private EditContext editContext;
    private bool isSubmit = false;
    public class CombinedFormModel
    {
        public CoordonneeFormModel CoordonneeFormModel { get; set; }
        public IdenticationFormModel IdentificationFormModel { get; set; }

        public void FillData(Coordonnee coordonnee, Identification identification, List<Portail_OptiVille.Data.Models.Telephone> telephones)
        {
            CoordonneeFormModel.IdCoordonnee = coordonnee.IdCoordonnee;
            CoordonneeFormModel.NoEntreprise = coordonnee.NoCivique;
            CoordonneeFormModel.RueEntreprise = coordonnee.Rue;
            CoordonneeFormModel.BureauEntreprise = coordonnee.Bureau;
            CoordonneeFormModel.VilleEntreprise = coordonnee.Ville;
            CoordonneeFormModel.ProvinceEntreprise = coordonnee.Province;
            CoordonneeFormModel.CodePostalEntreprise = coordonnee.CodePostal;
            CoordonneeFormModel.CodeRegionAdmEntreprise = coordonnee.CodeRegionAdministrative;
            CoordonneeFormModel.RegionAdmEntreprise = "(" + coordonnee.CodeRegionAdministrative + ") " + coordonnee.RegionAdministrative;
            Console.WriteLine(CoordonneeFormModel.RegionAdmEntreprise);
            CoordonneeFormModel.SiteWebEntreprise = coordonnee.SiteInternet;
            CoordonneeFormModel.PhoneList = telephones.Select(t => new TelephoneFormModel
            {
                IdTelephone = t.IdTelephone,
                NoTelEntreprise = t.NumTelephone,
                TypeTelEntreprise = t.Type,
                PosteTelEntreprise = t.Poste
            }).ToList();
            IdentificationFormModel.IdIdentification = identification.IdIdentification;
            IdentificationFormModel.NEQ = identification.Neq;
            IdentificationFormModel.NomEntreprise = identification.NomEntreprise;
            IdentificationFormModel.CourrielEntreprise = identification.AdresseCourriel;
            IdentificationFormModel.MotDePasse = identification.MotDePasse;
        }
        public CombinedFormModel()
        {
            CoordonneeFormModel = new CoordonneeFormModel();
            IdentificationFormModel = new IdenticationFormModel();
        }
    }
#region Modals
    private async Task ShowContactModalAsync()
    {
        await JSRuntime.InvokeVoidAsync("showBootstrapModal", "ContactModal");
    }
    private async Task ShowPieceJointesModalAsync()
    {
        await JSRuntime.InvokeVoidAsync("showBootstrapModal", "ModifierModalPieceJointe");
    }
    private async Task ShowHistoriqueModalAsync()
    {
        await JSRuntime.InvokeVoidAsync("showBootstrapModal", "historiqueModal");
    }
    
#endregion
#region EditComponents+Save
    private void ModifcationFinances()
    {
        modificationFinances = false;
    }
    private void ModificationContact()
    {
        modificationContact = false;
    }

    private void ModifcationInfo()
    {
        modificationInfo = false;
    }
    private void ModifcationPieceJointes()
    {
        modificationPieceJointes = false;
        ModifcationPieceJointesActivationONStateMethod();
    }
    private async Task SaveModifcationPieceJointes()
    {
        modificationPieceJointes = true;
        ModifcationPieceJointesActivationONStateMethod();
        await fichierService.UpdateFichierData(pieceJointeFormModel, selectedFournisseur.IdFournisseur, email);
    }
    private async Task SaveModifcationLicenceRBQ()
    {
        Task<bool> isValidTask = licenceRBQRef.TriggerValidation();
        bool isValid = await isValidTask;
        if (!isValid)
        {
            return;
        }
        await licenceRBQService.SaveLicenceRBQData(licenceRBQFormModel, email, selectedFournisseur.IdFournisseur);
        licencerbqs.Statut = licenceRBQFormModel.StatutLicence;
        licencerbqs.Type = licenceRBQFormModel.TypeLicence;
        licencerbqs.IdLicenceRbq = licenceRBQFormModel.NumeroLicence;
        selectedCategorieRBQ = await _context.Categorierbqs.Where(c => c.IdLicenceRbqs.Any(l => l.IdLicenceRbq == licencerbqs.IdLicenceRbq)).ToListAsync();
        groupedCategories = GroupCategoriesByType();
        await JSRuntime.InvokeVoidAsync("hideModal", "ModifierModalLicence");
        
    }

    private async Task SaveModifcationProduitServices()
    {
        bool isValid = produitServiceRef.TriggerValidation();
        if (!isValid)
        {
            return;
        }
        await produitServiceService.UpdateProduitServiceData(produitServiceFormModel, selectedFournisseur.IdFournisseur, email);
        selectedProduitservices = allProduitService
        .Where(p => produitServiceFormModel.SousProduitSelected.ContainsKey(p.CodeUnspsc) &&
                    produitServiceFormModel.SousProduitSelected[p.CodeUnspsc])
        .ToList();
        GetGroupProduitService();
        await JSRuntime.InvokeVoidAsync("hideModal", "exampleModal");
    }

    private async Task SaveModifcationFinances()
    {
        bool isValid = TriggerValidation();
        if (isValid)
        {
            await financeService.UpdateFinanceData(financeFormModel, selectedFournisseur.IdFournisseur, email);
            modificationFinances = true; 
        } 
    }

    private async Task SaveContact()
    {
        await contactsService.UpdateContactsData(contactHosterFormModel, selectedFournisseur.IdFournisseur, email);

        modificationContact = true;
        await JSRuntime.InvokeVoidAsync("hideModal", "ContactModal");
    }

    private async Task SaveModifcationInfo()
    {
        var isValidInfoGen = ValidationsInformationGen();
        var isAllPhonesValid = ValidatePhones();
        if (isAllPhonesValid && isValidInfoGen)
        {
            modificationInfo = true;
            for (int i = 0; i < errorMessagesInfoGen.Length; i++)
            {
                errorMessagesInfoGen[i] = ValidateField(true, string.Empty);
            }
            await identificationService.UpdateIdentificationData(combinedFormModel.IdentificationFormModel, email);
            await coordonneeService.UpdateCoordonneeData(combinedFormModel.CoordonneeFormModel, email);
        }
    }

    private bool ValidationsInformationGen()
    {
        bool isValid = true;
        // NOM D'ENTREPRISE
        if (combinedFormModel.IdentificationFormModel.NomEntreprise.IsNullOrEmpty())
        {
            errorMessagesInfoGen[0] = ValidateField(false, "Nom requis");
            isValid = false;
        }
        else
        {
            errorMessagesInfoGen[0] = ValidateField(true, string.Empty);
        }

        // ADRESSE COURRIEL
        string courriel = combinedFormModel.IdentificationFormModel.CourrielEntreprise;
        if (courriel.IsNullOrEmpty())
        {
            errorMessagesInfoGen[1] = ValidateField(false, "Courriel requis");
            isValid = false;
        }
        else
        {
            string pattern = @"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$";
            if (!Regex.IsMatch(courriel, pattern, RegexOptions.IgnoreCase))
            {
                errorMessagesInfoGen[1] = ValidateField(false, "Format invalide");
                isValid = false;
            }
            else
            {
                errorMessagesInfoGen[1] = ValidateField(true, string.Empty);
            }
        }

        // NO CIVIQUE
        string noCivique = combinedFormModel.CoordonneeFormModel.NoEntreprise;
        if (noCivique.IsNullOrEmpty())
        {
            errorMessagesInfoGen[2] = ValidateField(false, "\u2116 requis");
            isValid = false;
        }
        else
        {
            string pattern = @"^[a-zA-Z0-9]{1,8}$";
            if (!Regex.IsMatch(noCivique, pattern, RegexOptions.IgnoreCase))
            {
                errorMessagesInfoGen[2] = ValidateField(false, "Entre 1 à 8 chiffres ou lettres");
                isValid = false;
            }
            else
            {
                errorMessagesInfoGen[2] = ValidateField(true, string.Empty);
            }
        }

        // RUE
        if (combinedFormModel.CoordonneeFormModel.RueEntreprise.IsNullOrEmpty())
        {
            errorMessagesInfoGen[3] = ValidateField(false, "Rue requise");
            isValid = false;
        }
        else
        {
            errorMessagesInfoGen[3] = ValidateField(true, string.Empty);
        }

        // VILLE
        if (combinedFormModel.CoordonneeFormModel.VilleEntreprise.IsNullOrEmpty())
        {
            errorMessagesInfoGen[4] = ValidateField(false, "Ville requise");
            isValid = false;
        }
        else
        {
            errorMessagesInfoGen[4] = ValidateField(true, string.Empty);
        }

        // CODE POSTAL
        string CP = combinedFormModel.CoordonneeFormModel.CodePostalEntreprise;
        if (CP.IsNullOrEmpty())
        {
            errorMessagesInfoGen[5] = ValidateField(false, "CP requis");
            isValid = false;
        }
        else
        {
            string pattern = @"^(?!.*[DFIOQU])[A-VXY][0-9][A-Z] ?[0-9][A-Z][0-9]$";
            if (!Regex.IsMatch(CP, pattern, RegexOptions.IgnoreCase))
            {
                errorMessagesInfoGen[5] = ValidateField(false, "Format invalide");
                isValid = false;
            }
            else
            {
                errorMessagesInfoGen[5] = ValidateField(true, string.Empty);
            }
        }
        return isValid;
    }

    private string ValidateField(bool state, string errorMessage)
    {
        return state ? "" 
                       : "<span class=\"input-group-text text-danger\"><i class=\"bi bi-x-circle me-2\"></i><span class=\"texte-validation\">" + errorMessage + "</span></span>"; 
    }

    private string ValidateClass(string errorMessage)
    {
        if (errorMessage.IsNullOrEmpty())
        {
            return string.Empty;
        }
        return "invalid";
    }
#endregion
    public class GroupKey
    {
        public string? CodeCategorie { get; set; }
        public string? Nature { get; set; }

        public override bool Equals(object? obj)
        {
            if (obj is GroupKey other)
            {
                return CodeCategorie == other.CodeCategorie && Nature == other.Nature;
            }
            return false;
        }

        public override int GetHashCode()
        {
            return HashCode.Combine(CodeCategorie, Nature);
        }
    }

    private Dictionary<string, List<Categorierbq>> GroupCategoriesByType()
    {
        var groupedCategories = new Dictionary<string, List<Categorierbq>>();
        foreach (var categorie in selectedCategorieRBQ)
        {
            if (!groupedCategories.ContainsKey(categorie.NomCategorie!))
            {
                groupedCategories[categorie.NomCategorie!] = new List<Categorierbq>();
            }
            groupedCategories[categorie.NomCategorie!].Add(categorie);
        }

        return groupedCategories;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender){
        try {
            var result = await protectedSessionStorage.GetAsync<string>("Email");
            if (!result.Success || string.IsNullOrEmpty(result.Value))
            {
                throw new UserNotAuthenticatedException("Employé non connecté ou session expirée.");
            }
            else {
                // JE VEUX L'EMAIL
                email = result.Value;
            }
        } 
        catch(UserNotAuthenticatedException ex)
        {
            Console.WriteLine($"Erreur lors de la récupération de l'adresse courriel: {ex.Message}");
            navigationManager.NavigateTo("/",true);
        }
    } 

    public class ContactPhoneInfo
    {
        public Portail_OptiVille.Data.Models.Contact Contact { get; set; }
        public List<Telephone> PhoneNumbers { get; set; }
    }
    private ProduitServiceFormModel produitServiceFormModel = new ProduitServiceFormModel();
    private List<Produitservice> allProduitService = new List<Produitservice>();
    private string RaisonDuRefus;
    private List<Produitservice>? selectedProduitservices = new List<Produitservice>();
    private List<Categorieunspsc> categorieUNSPSC = new List<Categorieunspsc>();
    private List<string> AllCodeSousCategorie = new List<string>();
    private ProduitsServices produitServiceRef;    
    ContactFormModel contactFormModel = new ContactFormModel();
    List<string>? fournisseurProduitIds = new List<string>();
    private Action<ProduitsServices> AssignReferenceProduitsServices => (produitsServices) => produitServiceRef = produitsServices;
    List<IBrowserFile> browserFiles = new List<IBrowserFile>();
    public class MyBrowserFile : IBrowserFile
    {
        private readonly Fichier _fichier;

        public MyBrowserFile(Fichier fichier)
        {
            _fichier = fichier ?? throw new ArgumentNullException(nameof(fichier));
        }

        public string Name => _fichier.Nom ?? "Unnamed"; // Fallback if Nom is null
        public long Size => _fichier.Taille ?? 0; // Fallback if Taille is null
        public string ContentType => _fichier.Type ?? "application/octet-stream"; // Default content type
        public DateTimeOffset LastModified => _fichier.DateCreation ?? DateTime.Now;
        public async Task<Stream> OpenReadAsync()
        {
            // Simulate getting a stream from the file path
            // Ensure that the file path exists and is accessible in your application context
            if (string.IsNullOrEmpty(_fichier.Path))
            {
                throw new InvalidOperationException("File path is not set.");
            }

            return await Task.FromResult(new FileStream(_fichier.Path, FileMode.Open, FileAccess.Read));
        }

        public async Task<Stream> OpenReadStream(long maxAllowedSize, CancellationToken cancellationToken)
        {
            // Validate file size
            if (Size > maxAllowedSize)
            {
                throw new InvalidOperationException($"File size exceeds the allowed limit of {maxAllowedSize} bytes.");
            }

            if (string.IsNullOrEmpty(_fichier.Path))
            {
                throw new InvalidOperationException("File path is not set.");
            }

            // Return a FileStream for reading the file
            return await Task.FromResult(new FileStream(_fichier.Path, FileMode.Open, FileAccess.Read, FileShare.Read, 4096, FileOptions.Asynchronous));
        }

        Stream IBrowserFile.OpenReadStream(long maxAllowedSize, CancellationToken cancellationToken)
        {
            throw new NotImplementedException();
        }
    }
    protected override async Task OnInitializedAsync()
    {
        editContext = new EditContext(financeFormModel);
        editContext.OnValidationStateChanged += (sender, args) => StateHasChanged();
        try
        {
            selectedFournisseur = await _context.Fournisseurs.FindAsync(Id);
            selectedContacts = await _context.Contacts.Where(c => c.Fournisseur == selectedFournisseur.IdFournisseur).ToListAsync();

            foreach (var contact in selectedContacts)
            {
                var phoneNumber = await _context.Telephones.Where(t => t.Contact == contact.IdContact).FirstAsync();

                contactFormModel = new ContactFormModel
                {
                    IdContact = contact.IdContact,
                    Prenom = contact.Prenom,
                    Nom = contact.Nom,
                    Fonction = contact.Fonction,
                    AdresseCourriel = contact.AdresseCourriel,
                    TypeTelephone = phoneNumber.Type, 
                    Telephone = phoneNumber.NumTelephone,
                    Poste = phoneNumber.Poste
                };
                contactHosterFormModel.ContactList.Add(contactFormModel);
            }
            //contactHosterFormModel.ContactList.RemoveAt(0);
            coordonnee = await _context.Coordonnees.SingleAsync(c => c.Fournisseur == selectedFournisseur.IdFournisseur);
            selectedTelephones = await _context.Telephones.Where(t => t.Coordonnee == coordonnee.IdCoordonnee).ToListAsync();
            try
            {
                finance = await _context.Finances.SingleAsync(c => c.Fournisseur == selectedFournisseur.IdFournisseur);
                financeFormModel.FillData(finance);
                if(finance == null)
                {
                    FinanceInfoNull = true;
                }
            }
            catch(Exception ex)
            {
                Console.WriteLine($"Erreur lors de la récupération des informations(Finance): {ex.Message}"); 
                FinanceInfoNull = true;
            }
            identification = await _context.Identifications.SingleAsync(c => c.Fournisseur == selectedFournisseur.IdFournisseur);
            selectedFichiers = await _context.Fichiers.Where(c => c.Fournisseur == selectedFournisseur.IdFournisseur).ToListAsync();
            var browserfiles = TransformFichierToBrowserFile(selectedFichiers);
            // Pt que lister la liste des fichiers sur le serv comme sa deja en ibrowserfile ** A voir**
            pieceJointeFormModel = new PieceJointeFormModel{
                ListFichiers = selectedFichiers
            };
            selectedHistoriques = await _context.Historiques.Where(c => c.Fournisseur == Id).ToListAsync();
            closestHistorique = selectedHistoriques.Where(h => h.DateEtatChanged.HasValue).OrderBy(h => Math.Abs((h.DateEtatChanged.Value - DateTime.UtcNow).TotalDays)).FirstOrDefault();
            //closestHistorique = await _context.Historiques.Where(h => h.Fournisseur == selectedFournisseur.IdFournisseur && h.DateEtatChanged.HasValue).OrderBy(h => Math.Abs((h.DateEtatChanged.Value - DateTime.UtcNow).TotalDays)).FirstOrDefaultAsync();

            try
            {
                licencerbqs = await _context.Licencerbqs.SingleAsync(c => c.Fournisseur == selectedFournisseur.IdFournisseur);
            }
            catch(Exception ex)
            {
                Console.WriteLine($"Erreur lors de la récupération de la licence: {ex.Message}"); 
            }

            if(licencerbqs != null)
            {
                allCategoriesForm = await _context.Categorierbqs.ToListAsync();
                allCategories = await _context.Categorierbqs.ToListAsync();
                selectedCategorieRBQ = await _context.Categorierbqs.Where(c => c.IdLicenceRbqs.Any(l => l.IdLicenceRbq == licencerbqs.IdLicenceRbq)).ToListAsync();
                selectedLicencerbqs = await _context.Licencerbqs.Where(l => l.Fournisseur == selectedFournisseur.IdFournisseur).Include(l => l.IdCategorieRbqs).ToListAsync();
                selectedCurrentCategorieRBQ = allCategoriesForm.ToDictionary(c => c.CodeSousCategorie, c => false);

                foreach(var categorie in allCategoriesForm)
                {
                    AllCodeSousCategorie.Add(categorie.CodeSousCategorie);
                }

                licenceRBQFormModel = new LicenceRBQFormModel
                {
                    NumeroLicence = licencerbqs.IdLicenceRbq,
                    StatutLicence = licencerbqs.Statut,
                    TypeLicence = licencerbqs.Type,
                    CodeSousCategorie = AllCodeSousCategorie,
                    SousCategoSelected = selectedCurrentCategorieRBQ
                };

                foreach(var item in selectedCurrentCategorieRBQ)
                {
                    foreach(var cate in selectedCategorieRBQ)
                    {
                        if (cate.CodeSousCategorie == item.Key)
                        {
                            licenceRBQFormModel.SousCategoSelected[item.Key] = true;
                        }
                    }
                }
            }

            if(licencerbqs == null && selectedCategorieRBQ == null)
            {
                LicenceRBQInfoNull = true;
            }

            Console.WriteLine("allCategoriesRBQ.count:" + allCategories.Count);
            fournisseurProduitIds = await _context.Database
            .SqlQueryRaw<string>(@"
                SELECT idProduitService 
                FROM FournisseurProduitService 
                WHERE idFournisseur = {0}", selectedFournisseur.IdFournisseur)
            .ToListAsync();
            produitServiceFormModel = new ProduitServiceFormModel
            {
                Message = selectedFournisseur.DetailSpecification
            };
            allProduitService = await _context.Produitservices.ToListAsync();
            Console.WriteLine($"allProduitService count in parent: {allProduitService.Count}");
            if (allProduitService != null && allProduitService.Any())
            {
                produitServiceFormModel.SousProduitSelected = allProduitService.ToDictionary(c => c.CodeUnspsc, c => false);
            }
            categorieUNSPSC = await _context.Categorieunspscs.ToListAsync();
            configappro = await _context.Configappros.SingleAsync();
            MaxSize = configappro.TailleMaxFichiers;
            selectedProduitservices = await _context.Produitservices
                .Where(p => fournisseurProduitIds.Contains(p.CodeUnspsc))
                .ToListAsync();
            foreach(var item in selectedProduitservices)
            {
                if (produitServiceFormModel.SousProduitSelected.ContainsKey(item.CodeUnspsc))
                {
                    produitServiceFormModel.SousProduitSelected[item.CodeUnspsc] = true;
                }
            }
            GetGroupProduitService();
            if(closestHistorique.RaisonRefus != null)
            {
                RaisonDuRefus = encryptionService.Decrypt(closestHistorique.RaisonRefus);
            }
            groupedCategories = GroupCategoriesByType();
            combinedFormModel.FillData(coordonnee, identification, selectedTelephones);
            phoneExistsResults = await GetPhoneExistenceResults();
            Console.WriteLine("Fin Fetch Data");
            ModifcationPieceJointesActivationONStateMethod();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de la récupération des informations(Fetch Crash): {ex.Message}");
        }
        isLoading = false;
        
        // Initialise `currentValue` avec l'état de la demande actuelle
        var lastHistorique = await _context.Historiques
            .Where(h => h.Fournisseur == Id)
            .OrderByDescending(h => h.DateEtatChanged)
            .FirstOrDefaultAsync();

        currentValue = lastHistorique?.EtatDemande ?? "En attente";
        Console.WriteLine("currentValue: " + currentValue);
        previousValue = currentValue;
    }

    private async Task<List<bool>> GetPhoneExistenceResults()
    {
        var results = new List<bool>();
        foreach (var phoneModel in combinedFormModel.CoordonneeFormModel.PhoneList!)
        {
            bool exists = await _context.Telephones.AnyAsync(p => p.NumTelephone.Equals(phoneModel.NoTelEntreprise));
            results.Add(exists);
        }
        return results;
    }

    private void AddTelephone()
    {
        phoneExistsResults.Add(false);
        combinedFormModel.CoordonneeFormModel.PhoneList.Add(new TelephoneFormModel());
    }

    private void RemoveTelephone()
    {
        if (combinedFormModel.CoordonneeFormModel.PhoneList.Count > 1) {
            phoneExistsResults.RemoveAt(phoneExistsResults.Count - 1);
            combinedFormModel.CoordonneeFormModel.PhoneList.RemoveAt(combinedFormModel.CoordonneeFormModel.PhoneList.Count - 1);
        }
    }

    public bool ValidatePhones()
    {
        bool isValid = true;
        foreach (var component in telephoneComponents.Values) {
            var phoneState = component.TriggerValidation();
            if (!phoneState) {
                isValid = false;
            }
        }
        return isValid;
    }

    private string GetInputClass<TField> (Expression<Func<TField>> fieldExpression)
    {
        if (!isSubmit || isValidFormFinance) {
            return "";
        }
        var fieldIdentifier = FieldIdentifier.Create(fieldExpression);
        var isValid = !editContext.GetValidationMessages(fieldIdentifier).Any();
        return isValid ? "valid" : "invalid";
    }

    private string GetValidationHTML<TField> (Expression<Func<TField>> fieldExpression) 
    {
        if (!isSubmit || isValidFormFinance) {
            return "";
        }
        var fieldIdentifier = FieldIdentifier.Create(fieldExpression);
        var isValid = !editContext.GetValidationMessages(fieldIdentifier).Any();
        return isValid ? "<span class=\"input-group-text text-success\"><i class=\"bi bi-check-circle me-2\"></i><span class=\"texte-validation\">Valide</span></span>" 
                       : "<span class=\"input-group-text text-danger\"><i class=\"bi bi-x-circle me-2\"></i><span class=\"texte-validation\">" + editContext.GetValidationMessages(fieldIdentifier).FirstOrDefault() + "</span></span>";  
    }

    public bool TriggerValidation() 
    {
        isSubmit = true;
        isValidFormFinance = editContext.Validate();
        return isValidFormFinance;
    }

    private void GetGroupProduitService()
    {
        groupedServices = selectedProduitservices.GroupBy(p => new GroupKey 
            { 
                CodeCategorie = p.CategorieUnspsc, 
                Nature = p.Nature 
            }).ToList(); 
    }

    private string GetFormatSizeFile(int? size)
    {
        if (size >= 1048576)
        {
            return $"{(size / 1048576.0):F2} MB";
        }
        else
        {
            return $"{(size / 1024.0):F2} KB";
        }
    }
 
    private string GetFormatSize()
    {
        sizeTotal = pieceJointeFormModel.ListFichiers.Sum(file => (int)(file.Taille));
        if (sizeTotal >= 1048576) // 1 MB = 1048576 bytes (1 * 1024 * 1024)
        {
            return $"{(sizeTotal / 1048576.0):F2} MB / {MaxSize}MB";
        }
        else
        {
            return $"{(sizeTotal / 1024.0):F2} KB / {MaxSize}MB";
        }
    }

    private async Task ChangementDemande()
    {
        if(closestHistorique.EtatDemande == "Refusé")
        {
            var newHistorique = new Historique
            {
                EtatDemande = "En attente",
                DateEtatChanged = DateTime.UtcNow,
                Fournisseur = closestHistorique.Fournisseur
            };
            _context.Historiques.Add(newHistorique);
            closestHistorique.EtatDemande = "En attente";
            closestHistorique.DateEtatChanged = DateTime.UtcNow;
            await _context.SaveChangesAsync();
        }
    }

    private async Task DeleteFiche()
    {
        var result = await protectedSessionStorage.GetAsync<string>("Email");
        if(!result.Success)
        {
            var token = await cookie.GetValue("SToken");
            if(!string.IsNullOrEmpty(token))
            {
                var email = tokenGenerator.GetValueFromToken(token).Split(":")[0];
                await historiqueService.ModifyEtat("Désactivée",selectedFournisseur.IdFournisseur, email, null, null, null);//A mettre un message que l'admin peut changer
            }
        }
        else
        {
            await historiqueService.ModifyEtat("Désactivée",selectedFournisseur.IdFournisseur, result.Value, null, null, null);//A mettre un message que l'admin peut changer
            
        }
        await fichierService.DeleteAllFichiersData(selectedFichiers);
        selectedFichiers.Clear();// A enlever si on peut changer les donnnes sans refresh la page
    }

    public class CustomBrowserFile : IBrowserFile
    {
        public string Name { get; set; }
        public DateTimeOffset LastModified { get; set; }
        public long Size { get; set; }
        public string ContentType { get; set; }

        // Example method to simulate getting a Stream for the file content
        public Stream OpenReadStream(long maxAllowedSize = 512000, CancellationToken cancellationToken = default)
        {
            // Implement this method as needed
            return new MemoryStream();
        }
    }
    public List<IBrowserFile> TransformFichierToBrowserFile(List<Fichier> fichiers)
    {
        return fichiers.Select(f => new CustomBrowserFile
        {
            Name = f.Nom,
            LastModified = f.DateCreation.HasValue ? new DateTimeOffset(f.DateCreation.Value) : DateTimeOffset.Now, // Handle null DateTime
            Size = f.Taille ?? 0, // Handle null int
            ContentType = f.Type
        }).ToList<IBrowserFile>();
    }

    private async Task Deconnexion()
    {
        Usersession[] usersessions;
        string email;

        var result = await protectedSessionStorage.GetAsync<string>("Email"); // Je vais chercher le mail dans le protectedSessionStorage

        email = result.Value;
        usersessions = _context.Usersessions.Where(u => u.OwnerEmail == email).ToArray();
        if(usersessions.Length > 0)
        {
            foreach (var usersession in usersessions)
            {
                _context.Usersessions.Remove(usersession);
            }
            await _context.SaveChangesAsync();    

            await protectedSessionStorage.DeleteAsync("Email");
            await cookie.destroy("SToken");
        }
        else
        {
            var token = await cookie.GetValue("SToken");
            if(!string.IsNullOrEmpty(token))
            {
                email = tokenGenerator.GetValueFromToken(token).Split(":")[0];
                usersessions = _context.Usersessions.Where(u => u.OwnerEmail == email).ToArray();
                foreach (var usersession in usersessions)
                {
                    _context.Usersessions.Remove(usersession);
                }
                await _context.SaveChangesAsync();
            }
            
            await protectedSessionStorage.DeleteAsync("Email");
            await cookie.destroy("SToken");
        } 


        // usersessions = _context.Usersessions.Where(u => u.OwnerEmail == email).ToArray();
        // foreach (var usersession in usersessions)
        // {
        //     _context.Usersessions.Remove(usersession);
        // }
        // await _context.SaveChangesAsync();
        
        NavigationManager.NavigateTo("/", true);
    }

        private string previousValue;
    private string currentValue;


private async Task ConfirmChange(ChangeEventArgs e)
    {
        string? newValue = e.Value?.ToString();
        // Appel de la fonction JavaScript pour confirmer le changement
            var isConfirmed = await JSRuntime.InvokeAsync<bool>("confirmSelectionChange");

            if (isConfirmed)
            {
                if(newValue != "Refusé")
                {
                    // Si confirmé, on met à jour `previousValue` avec `newValue`
                    isRefused = false;
                    previousValue = newValue;
                    currentValue = newValue;
                    await MyConfirmedMethod();
                }
                else
                {
                    isRefused = true;
                }
            }
            else
            {
                // Si non confirmé, réinitialise temporairement `currentValue` pour forcer la synchronisation
                currentValue = "En attente";  // Valeur temporaire pour "désélectionner" l'élément
                StateHasChanged();   // Forcer l'interface à mettre à jour
                await Task.Delay(1); // Pause rapide pour garantir la prise en compte du changement
                currentValue = previousValue;  // Retourne à la valeur précédente
                StateHasChanged();
            }
    }

    private async Task MyConfirmedMethod()
    {
            var result = await protectedSessionStorage.GetAsync<string>("Email");
            if(result.Success)
            {
                var email = result.Value;
                var user = await _context.Usersessions.FirstOrDefaultAsync(u => u.OwnerEmail == email);
                if(user is not null)
                {
                    var historique = new Historique
                    {
                        EtatDemande = currentValue,
                        DateEtatChanged = DateTime.Now,
                        Fournisseur = Id,
                        ModifiePar = user.OwnerEmail
                    };
                    _context.Historiques.Add(historique);
                    await _context.SaveChangesAsync();
                    isConfirmed = true;
                }
                else
                {
                    Console.WriteLine("Utilisateur introuvable");
                }
            }
            else
            {
                try{

                    var Token = await cookie.GetValue("SToken");
                    var Email = tokenGenerator.GetValueFromToken(Token).Split(":")[0];
                    var user = await _context.Usersessions.FirstOrDefaultAsync(u => u.OwnerEmail == Email);
                    if(user is not null)
                    {
                        var historique = new Historique
                        {
                            EtatDemande = currentValue,
                            DateEtatChanged = DateTime.Now,
                            Fournisseur = Id,
                            ModifiePar = user.OwnerEmail
                        };
                        _context.Historiques.Add(historique);
                        await _context.SaveChangesAsync();
                        isConfirmed = true;
                    }
                    else
                    {
                        await JSRuntime.InvokeVoidAsync("alert", "Vous devez vous connecter pour modifier une fiche");
                        Console.WriteLine("Utilisateur introuvable");
                        navigationManager.NavigateTo("/",true);
                    }
                }catch
                {
                    await JSRuntime.InvokeVoidAsync("alert", "Vous devez vous connecter pour modifier une fiche");
                    Console.WriteLine("Erreur lors de la récupération de l'adresse courriel");
                    navigationManager.NavigateTo("/",true);
                }
            }
                
    }

    private async Task ConfirmRefus()
    {
        var isConfirmed = await JSRuntime.InvokeAsync<bool>("confirmRefus");
        if (isConfirmed)
        {   
            string[] newData = {encryptionService.Encrypt(strRaisonRefus)};
            string[] keyData = {"Raison du refus"};
            var oldDict = new Dictionary<string, object> { { "Section", "Historique" } };
            var newDict = new Dictionary<string, object> { { "Section", "Historique" } };
            for (int i = 0; i < newData.Length; i++)
                {
                        newDict.Add(keyData[i], newData[i]);
                }
                string newJSON = JsonConvert.SerializeObject(newDict, Formatting.None);
            await historiqueService.ModifyEtat("Refusé", selectedFournisseur.IdFournisseur, email, encryptionService.Encrypt(strRaisonRefus), null, newJSON);
        }
        Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
    }
}